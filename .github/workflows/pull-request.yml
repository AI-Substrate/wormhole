name: Pull Request Checks

# DISABLED: Extension Host testing not yet configured for GitHub Actions
# Re-enable after implementing CI-compatible Extension Host setup
on:
  workflow_dispatch:

jobs:
  test:
    name: Test Changes
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Setup Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: |
          extension/package-lock.json
          mcp-server/package-lock.json

    - name: Install extension dependencies
      working-directory: ./extension
      run: npm ci

    - name: Install MCP server dependencies
      working-directory: ./mcp-server
      run: npm ci

    - name: Lint extension
      working-directory: ./extension
      run: npm run lint

    - name: Lint MCP server
      working-directory: ./mcp-server
      run: npm run lint

    - name: Build extension
      working-directory: ./extension
      run: npm run compile

    - name: Build MCP server
      working-directory: ./mcp-server
      run: npm run build

    - name: Cache VS Code download
      uses: actions/cache@v4
      with:
        path: .vscode-test
        key: vscode-test-cache-${{ runner.os }}-stable
        restore-keys: |
          vscode-test-cache-${{ runner.os }}-

    - name: Run extension tests
      working-directory: ./extension
      run: |
        sudo apt-get update
        sudo apt-get install -y xvfb
        # Single Extension Host test run with xvfb
        xvfb-run -a npm test

  build-test:
    name: Test Docker Build
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker image (test only)
      uses: docker/build-push-action@v6
      with:
        context: ./mcp-server
        file: ./mcp-server/Dockerfile
        push: false
        tags: vsc-bridge-mcp-server:test
        cache-from: type=gha
        cache-to: type=gha,mode=max

  security-check:
    name: Security Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Setup Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: |
          extension/package-lock.json
          mcp-server/package-lock.json

    - name: Install extension dependencies
      working-directory: ./extension
      run: npm ci

    - name: Install MCP server dependencies
      working-directory: ./mcp-server
      run: npm ci

    - name: Run security audit on extension
      working-directory: ./extension
      run: npm audit --audit-level moderate

    - name: Run security audit on MCP server
      working-directory: ./mcp-server
      run: npm audit --audit-level moderate
